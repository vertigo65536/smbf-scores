{% load static %}
<head>
        <link rel="stylesheet" href="{% static 'css/view_master.css'%}?{%now "U"%}">
        <link id="customstyle" rel="stylesheet" href="">
<svg>
    <filter id="pixelate" x="0" y="0" width="100%" height="100%">
        <feConvolveMatrix kernelMatrix="1 1 1
                              1 1 1
                              1 1 1" result="AVG" />
        <feFlood x="1" y="1" width="1" height="1" />
        <feComposite width="2" height="2" />
        <feTile result="TILE" />
        <feComposite in="AVG" in2="TILE" operator="in" />
        <feMorphology operator="dilate" radius="1" />
    </filter>
</svg>
</head>
<body>
<div id="wrapper" class="up">
        <div class="p1 fullblock">
                <div class="p1 nameblock">
                        <table class="nametable">
                                <tr>
                                        <td class="p1 text prefix" id="p1prefix"></td>
                                        <td class="p1 text name" id="p1name" ></td>
                                </tr>
                        </table>
                </div>
                <div class="p1 scoreblock">
                        <p class="p1 text score" id="p1score"></p>
                </div>
        </div>
        <div class="centertextblock">
                <p id="centertext"></p>
        </div>
        <div class="p2 fullblock">
                <div class="scoreblock p2scoreblock">
                        <p class="p2 text score" id="p2score"></p>
                </div>
                <div class="nameblock p2nameblock">
                        <table class="nametable">
                                <tr>
                                        <td class="p2 text prefix" id="p2prefix"></td>
                                        <td class="p2 text name" id="p2name" ></td>
                                </tr>
                        </table>
                </div>
        </div>
</div>
<input type="hidden" id="scorecache" value="{}"></input>
</body>
<script>
        setInterval(() => fetch("{% url 'rawview' %}?s={{secret}}")
                .then(result => result.json())
                .then((output) => {
                        const cache_json = document.getElementById("scorecache").value;
                        var cache = JSON.parse(cache_json);
                        output_json = JSON.stringify(output);
                        if (output_json != cache_json) {
                                if (cache_json != "{}") {
                                        for (const[key,value] of Object.entries(output)){
                                                if (cache[key] != value) {
                                                        if (key == 'p1_score') {
                                                                animateScoreChange(output, 'p1score');
                                                        } else if (key == 'p2_score') {
                                                                animateScoreChange(output, 'p2score');
                                                        } else {
                                                                animateTextChange(output);
                                                        }
                                                }
                                        }
                                } else {
                                        updateScores(output);
                                }
                        }
                }), 1000);
        function updateScores(output) {
                document.getElementById("p1name").innerHTML = output['p1_name'];
                document.getElementById("p2name").innerHTML = output['p2_name'];
                document.getElementById("p1prefix").innerHTML = output['p1_tag'];
                document.getElementById("p2prefix").innerHTML = output['p2_tag'];
                document.getElementById("p1score").innerHTML = output['p1_score'];
                document.getElementById("p2score").innerHTML = output['p2_score'];
                document.getElementById("centertext").innerHTML = output['center_text'];
                document.getElementById("customstyle").href = "/static/css/".concat(output['style']).concat('?{%now "U"%}');
                document.getElementById("scorecache").value = JSON.stringify(output);

        }
        async function animateTextChange(output) {
                let wrapper = document.getElementById("wrapper")
                let fullblocks = document.querySelectorAll('.fullblock');
                wrapper.classList.remove("up");
                wrapper.classList.add("moveup");
                if (output['hidden'] == false) {
                        setTimeout(() => {
                                wrapper.classList.remove("moveup");
                        }, 1000);
                        for (var i = 0; i<fullblocks.length; i++) {
                                fullblocks[i].classList.remove("grow");
                                fullblocks[i].classList.add("shrink");
                        }
                        setTimeout(() => {
                                updateScores(output);
                                for (var i = 0; i<fullblocks.length; i++) {
                                        fullblocks[i].classList.remove("shrink");
                                        fullblocks[i].classList.add("grow");
                                }
                }, 1000);
                } else {
                        updateScores(output);
                }
        }
        function animateScoreChange(output, scoreId) {
                let scoreblock = document.getElementById(scoreId);
                scoreblock.classList.add("scoreup");
                setTimeout(() => {
                        updateScores(output);
                        scoreblock.classList.remove("scoreup");
                        scoreblock.classList.add("scoredown");
                }, 200);
                setTimeout(() => {
                        scoreblock.classList.remove("scoredown");
                }, 300);
        }
</script>
